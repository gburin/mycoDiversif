---
title: "Supplementary Material - Mujica et al."
output:
  pdf_document:
    toc: false
    fig_caption: true
    latex_engine: lualatex
    number_sections: true
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \floatplacement{table}{H}
  - \floatplacement{verbatim}{H}
---

```{r echo = FALSE}

knitr::opts_chunk$set(echo = FALSE, fig.width = 11, fig.height = 9, warning = FALSE, message = FALSE, fig.pos = 'H')
library("kableExtra")
library("caper")
library("tidyverse")
library("cowplot")
library("RColorBrewer")
rm(list = ls())
load("../output/main_results.RData")
sig.formatter <- function(x){cell_spec(x, format = "latex", bold = ifelse(x < 0.05, TRUE, FALSE))}
options(digits = 3)

```

# Phylogenetic signal of Mycorrhizal types

```{r}

data.phylo.d50 <- family.data.gen[, c("family", "type.50")]
data.phylo.d60 <- family.data.gen[, c("family", "type.60")]
data.phylo.d80 <- family.data.gen[, c("family", "type.80")]
data.phylo.d100 <- family.data.gen[, c("family", "type.100")]

## Threshold 50%

data.phylo.d50$dummy.am <- ifelse(data.phylo.d50$type.50 == "AM", 1, 0)
data.phylo.d50$dummy.em <- ifelse(data.phylo.d50$type.50 == "EM", 1, 0)
data.phylo.d50$dummy.mix <- ifelse(data.phylo.d50$type.50 == "MIX", 1, 0)
data.phylo.d50$dummy.nm <- ifelse(data.phylo.d50$type.50 == "NM", 1, 0)

d.am.50 <- phylo.d(data.phylo.d50, data.pgls$phy, names.col = family, binvar = dummy.am)
d.em.50 <- phylo.d(data.phylo.d50, data.pgls$phy, names.col = family, binvar = dummy.em)
d.mix.50 <- phylo.d(data.phylo.d50, data.pgls$phy, names.col = family, binvar = dummy.mix)
d.nm.50 <- phylo.d(data.phylo.d50, data.pgls$phy, names.col = family, binvar = dummy.nm)

## Threshold 60%

data.phylo.d60$dummy.am <- ifelse(data.phylo.d60$type.60 == "AM", 1, 0)
data.phylo.d60$dummy.em <- ifelse(data.phylo.d60$type.60 == "EM", 1, 0)
data.phylo.d60$dummy.mix <- ifelse(data.phylo.d60$type.60 == "MIX", 1, 0)
data.phylo.d60$dummy.nm <- ifelse(data.phylo.d60$type.60 == "NM", 1, 0)

d.am.60 <- phylo.d(data.phylo.d60, data.pgls$phy, names.col = family, binvar = dummy.am)
d.em.60 <- phylo.d(data.phylo.d60, data.pgls$phy, names.col = family, binvar = dummy.em)
d.mix.60 <- phylo.d(data.phylo.d60, data.pgls$phy, names.col = family, binvar = dummy.mix)
d.nm.60 <- phylo.d(data.phylo.d60, data.pgls$phy, names.col = family, binvar = dummy.nm)

## Threshold 80%

data.phylo.d80$dummy.am <- ifelse(data.phylo.d80$type.80 == "AM", 1, 0)
data.phylo.d80$dummy.em <- ifelse(data.phylo.d80$type.80 == "EM", 1, 0)
data.phylo.d80$dummy.mix <- ifelse(data.phylo.d80$type.80 == "MIX", 1, 0)
data.phylo.d80$dummy.nm <- ifelse(data.phylo.d80$type.80 == "NM", 1, 0)

d.am.80 <- phylo.d(data.phylo.d80, data.pgls$phy, names.col = family, binvar = dummy.am)
d.em.80 <- phylo.d(data.phylo.d80, data.pgls$phy, names.col = family, binvar = dummy.em)
d.mix.80 <- phylo.d(data.phylo.d80, data.pgls$phy, names.col = family, binvar = dummy.mix)
d.nm.80 <- phylo.d(data.phylo.d80, data.pgls$phy, names.col = family, binvar = dummy.nm)

## Threshold 100%

data.phylo.d100$dummy.am <- ifelse(data.phylo.d100$type.100 == "AM", 1, 0)
data.phylo.d100$dummy.em <- ifelse(data.phylo.d100$type.100 == "EM", 1, 0)
data.phylo.d100$dummy.mix <- ifelse(data.phylo.d100$type.100 == "MIX", 1, 0)
data.phylo.d100$dummy.nm <- ifelse(data.phylo.d100$type.100 == "NM", 1, 0)

d.am.100 <- phylo.d(data.phylo.d100, data.pgls$phy, names.col = family, binvar = dummy.am)
d.em.100 <- phylo.d(data.phylo.d100, data.pgls$phy, names.col = family, binvar = dummy.em)
d.mix.100 <- phylo.d(data.phylo.d100, data.pgls$phy, names.col = family, binvar = dummy.mix)
d.nm.100 <- phylo.d(data.phylo.d100, data.pgls$phy, names.col = family, binvar = dummy.nm)

phylod.table <- data.frame(
                            Threshold = rep(c(50, 60, 80, 100), each = 2),
                            model = rep(c("random", "BM"), times = 4),
                            AM = c(unlist(d.am.50[c("Pval1", "Pval0")]),
                                   unlist(d.am.60[c("Pval1", "Pval0")]),
                                   unlist(d.am.80[c("Pval1", "Pval0")]),
                                   unlist(d.am.100[c("Pval1", "Pval0")])),
                            EM = c(unlist(d.em.50[c("Pval1", "Pval0")]),
                                   unlist(d.em.60[c("Pval1", "Pval0")]),
                                   unlist(d.em.80[c("Pval1", "Pval0")]),
                                   unlist(d.em.100[c("Pval1", "Pval0")])),
                            MIX = c(unlist(d.mix.50[c("Pval1", "Pval0")]),
                                   unlist(d.mix.60[c("Pval1", "Pval0")]),
                                   unlist(d.mix.80[c("Pval1", "Pval0")]),
                                   unlist(d.mix.100[c("Pval1", "Pval0")])),
                            NM = c(unlist(d.nm.50[c("Pval1", "Pval0")]),
                                   unlist(d.nm.60[c("Pval1", "Pval0")]),
                                   unlist(d.nm.80[c("Pval1", "Pval0")]),
                                   unlist(d.nm.100[c("Pval1", "Pval0")]))
)

phylod.table[, 3:6] <- apply(phylod.table[, 3:6], 2, sig.formatter)

kable_styling(kable(x = phylod.table, format = "latex", caption = "P-values for test of phylogenetic signal (D) of each mycorrhizal type. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

# Analysis per genera excluding 100% MIX families

## Boxplots

### Threshold 50%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

### Threshold 60%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

### Threshold 80%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

### Threshold 100%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

## Summary statistics

### phyANOVA

```{r}

phyaov.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                                   F.r0 = round(c(phyaov.r0.50$F,
                                            phyaov.r0.60$F,
                                            phyaov.r0.80$F,
                                            phyaov.r0.100$F), 3),
                                   pvalue.r0 = round(c(phyaov.r0.50$Pf,
                                                 phyaov.r0.60$Pf,
                                                 phyaov.r0.80$Pf,
                                                 phyaov.r0.100$Pf), 3),
                                   F.r09 = round(c(phyaov.r09.50$F,
                                            phyaov.r09.60$F,
                                            phyaov.r09.80$F,
                                            phyaov.r09.100$F), 3),
                                   pvalue.r09 = round(c(phyaov.r09.50$Pf,
                                                 phyaov.r09.60$Pf,
                                                 phyaov.r09.80$Pf,
                                                 phyaov.r09.100$Pf), 3)
                         )

phyaov.sum[, 2:5] <- apply(phyaov.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = phyaov.sum, format = "latex", caption = "Summary statistics for phyANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

aov.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                      F.r0 = round(c(summary(aov.r0.50)[[1]]$F[1],
                                     summary(aov.r0.60)[[1]]$F[1],
                                     summary(aov.r0.80)[[1]]$F[1],
                                     summary(aov.r0.100)[[1]]$F[1]), 3),
                      pvalue.r0 = round(c(summary(aov.r0.50)[[1]]$P[1],
                                          summary(aov.r0.60)[[1]]$P[1],
                                          summary(aov.r0.80)[[1]]$P[1],
                                          summary(aov.r0.100)[[1]]$P[1]), 3),
                      F.r09 = round(c(summary(aov.r09.50)[[1]]$F[1],
                                      summary(aov.r09.60)[[1]]$F[1],
                                      summary(aov.r09.80)[[1]]$F[1],
                                      summary(aov.r09.100)[[1]]$F[1]), 3),
                      pvalue.r09 = round(c(summary(aov.r09.50)[[1]]$P[1],
                                           summary(aov.r09.60)[[1]]$P[1],
                                           summary(aov.r09.80)[[1]]$P[1],
                                           summary(aov.r09.100)[[1]]$P[1]), 3)
                      )

aov.sum[, 2:5] <- apply(aov.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = aov.sum, format = "latex", caption = "summary statistics for standard ANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```
## Posthoc tests

### phyANOVA

```{r}

sum.phyaov <- setNames(
                        data.frame(
                            threshold = rep(c(50, 60, 80, 100), each = 4),
                            Myc.type = rep(c("AM", "EM", "MIX", "NM"), times = 4),
                        rbind(phyaov.r0.50$Pt,
                              phyaov.r0.60$Pt,
                              phyaov.r0.80$Pt,
                              phyaov.r0.100$Pt),
                        rbind(phyaov.r09.50$Pt,
                              phyaov.r09.60$Pt,
                              phyaov.r09.80$Pt,
                              phyaov.r09.100$Pt)
                        ), nm = c("Threshold", "Mycorrhizal.Type", "AM.r0", "EM.r0", "MIX.r0", "NM.r0", "AM.r09", "EM.r09", "MIX.r09", "NM.r09"))
rownames(sum.phyaov) <- NULL

sum.phyaov[, 3:10] <- apply(sum.phyaov[, 3:10], 2, sig.formatter)

kable_styling(kable(x = sum.phyaov, format = "latex", caption = "Pairwise Corrected p-values for phyANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

sum.aov <- setNames(
    data.frame(
        pairs = names(TukeyHSD(aov.r0.50)$type.50[,4]),
        TukeyHSD(aov.r0.50)$type.50[,4],
        TukeyHSD(aov.r0.60)$type.60[,4],
        TukeyHSD(aov.r0.80)$type.80[,4],
        TukeyHSD(aov.r0.100)$type.100[,4],
        TukeyHSD(aov.r09.50)$type.50[,4],
        TukeyHSD(aov.r09.60)$type.60[,4],
        TukeyHSD(aov.r09.80)$type.80[,4],
        TukeyHSD(aov.r09.100)$type.100[,4]
        ), nm = c("Types", "50.r0", "60.r0", "80.r0", "100.r0", "50.r09", "60.r09", "80.r09", "100.r09"))

sum.aov <- apply(sum.aov, 2, sig.formatter)

kable_styling(kable(x = sum.aov, format = "latex", caption = "Pairwise Corrected p-values for standard ANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

## Phylogenetic signal of diversification rates, age, and richness

```{r}

kable_styling(kable(x = data.frame(Variable = c("r.e0", "r.e09", "Stem.Age", "Richness"),
                                   Lambda = c(summary(phylosig.r0)$param[2],
                                   summary(phylosig.r09)$param[2],
                                   summary(phylosig.age)$param[2],
                                   summary(phylosig.rich)$param[2]
                                   )),
                    format = "latex", caption = "Phylogenetic signal of the four response variables."), latex_options = "HOLD_position"
              )

```

# Analysis per genera including all families

```{r}

## This step is mandatory to avoid problems with overlapping object names
rm(list = ls())
load("../output/suppdata_genus_full.RData")
sig.formatter <- function(x){cell_spec(x, format = "latex", bold = ifelse(x < 0.05, TRUE, FALSE))}

```

## Boxplots

### Threshold 50%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

### Threshold 60%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

### Threshold 80%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

### Threshold 100%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.gen$type.50 <- as.character(family.data.gen$type.50)
family.data.gen$type.60 <- as.character(family.data.gen$type.60)
family.data.gen$type.80 <- as.character(family.data.gen$type.80)
family.data.gen$type.100 <- as.character(family.data.gen$type.100)

box.r0 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e0)),]) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = family.data.gen[-which(is.na(family.data.gen$r.e09)),]) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_brewer(palette = "Set1") +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

## Summary statistics

### phyANOVA

```{r}

phyaov.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                                   F.r0 = round(c(phyaov.r0.50$F,
                                            phyaov.r0.60$F,
                                            phyaov.r0.80$F,
                                            phyaov.r0.100$F), 3),
                                   pvalue.r0 = round(c(phyaov.r0.50$Pf,
                                                 phyaov.r0.60$Pf,
                                                 phyaov.r0.80$Pf,
                                                 phyaov.r0.100$Pf), 3),
                                   F.r09 = round(c(phyaov.r09.50$F,
                                            phyaov.r09.60$F,
                                            phyaov.r09.80$F,
                                            phyaov.r09.100$F), 3),
                                   pvalue.r09 = round(c(phyaov.r09.50$Pf,
                                                 phyaov.r09.60$Pf,
                                                 phyaov.r09.80$Pf,
                                                 phyaov.r09.100$Pf), 3)
                         )

phyaov.sum <- apply(phyaov.sum, 2, sig.formatter)

kable_styling(kable(x = phyaov.sum, format = "latex", caption = "summary statistics for phyANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

aov.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                      F.r0 = round(c(summary(aov.r0.50)[[1]]$F[1],
                                     summary(aov.r0.60)[[1]]$F[1],
                                     summary(aov.r0.80)[[1]]$F[1],
                                     summary(aov.r0.100)[[1]]$F[1]), 3),
                      pvalue.r0 = round(c(summary(aov.r0.50)[[1]]$P[1],
                                          summary(aov.r0.60)[[1]]$P[1],
                                          summary(aov.r0.80)[[1]]$P[1],
                                          summary(aov.r0.100)[[1]]$P[1]), 3),
                      F.r09 = round(c(summary(aov.r09.50)[[1]]$F[1],
                                      summary(aov.r09.60)[[1]]$F[1],
                                      summary(aov.r09.80)[[1]]$F[1],
                                      summary(aov.r09.100)[[1]]$F[1]), 3),
                      pvalue.r09 = round(c(summary(aov.r09.50)[[1]]$P[1],
                                           summary(aov.r09.60)[[1]]$P[1],
                                           summary(aov.r09.80)[[1]]$P[1],
                                           summary(aov.r09.100)[[1]]$P[1]), 3)
                      )
aov.sum <- apply(aov.sum, 2, sig.formatter)

kable_styling(kable(x = aov.sum, format = "latex", caption = "summary statistics for standard ANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

## Posthoc tests

### phyANOVA

```{r}

sum.phyaov <- setNames(
                        data.frame(
                            threshold = rep(c(50, 60, 80, 100), each = 4),
                            Myc.type = rep(c("AM", "EM", "MIX", "NM"), times = 4),
                        rbind(phyaov.r0.50$Pt,
                              phyaov.r0.60$Pt,
                              phyaov.r0.80$Pt,
                              phyaov.r0.100$Pt),
                        rbind(phyaov.r09.50$Pt,
                              phyaov.r09.60$Pt,
                              phyaov.r09.80$Pt,
                              phyaov.r09.100$Pt)
                        ), nm = c("Threshold", "Mycorrhizal.Type", "AM.r0", "EM.r0", "MIX.r0", "NM.r0", "AM.r09", "EM.r09", "MIX.r09", "NM.r09"))
rownames(sum.phyaov) <- NULL

sum.phyaov[, 3:10] <- apply(sum.phyaov[, 3:10], 2, sig.formatter)

kable_styling(kable(x = sum.phyaov, format = "latex", caption = "Pairwise Corrected p-values for phyANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

sum.aov <- setNames(
    data.frame(
        pairs = gsub("-", ".", names(TukeyHSD(aov.r0.50)$type.50[,4]), fixed = TRUE),
        TukeyHSD(aov.r0.50)$type.50[,4],
        TukeyHSD(aov.r0.60)$type.60[,4],
        TukeyHSD(aov.r0.80)$type.80[,4],
        TukeyHSD(aov.r0.100)$type.100[,4],
        TukeyHSD(aov.r09.50)$type.50[,4],
        TukeyHSD(aov.r09.60)$type.60[,4],
        TukeyHSD(aov.r09.80)$type.80[,4],
        TukeyHSD(aov.r09.100)$type.100[,4]
        ), nm = c("Pairs", "50.r0", "60.r0", "80.r0", "100.r0", "50.r09", "60.r09", "80.r09", "100.r09"))

sum.aov <- apply(sum.aov, 2, sig.formatter)

kable_styling(kable(x = sum.aov, format = "latex", caption = "Pairwise Corrected p-values for standard ANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

## Scatterplots

```{r fig.height = 5, fig.cap = "Scatterplots showing the relationship between mycorrhizal diversity index and diversification rates (a and c), species richness (b) and age family (d). Diversification rates were estimated with epsilon = 0 (a) and with epsilon = 0.9 (c). The red and blue lines indicate the results of a linear model and a phylogenetic generalized least squares (PGLS) fit, respectively."}

## Scatter - MTDI vs. Net Diversification
mtdi.r0 <-
    ggplot(data = na.omit(family.data.gen)) +
    geom_point(aes(x = shannon, y = r.e0), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.r0)[1], sl = coef(lm.r0)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, linetype = "dashed", show.legend = TRUE) +
    geom_abline(data = data.frame(int = coef(mod.r0)[1], sl = coef(mod.r0)[2], col = "b"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, show.legend = TRUE) +
    labs(x = "Mycorrhizal Type Shannon Index", y = "Diversification Rate", col = "Model Type") +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS"), direction = -1) +
    theme_cowplot() +
    theme(legend.position = "top")

mtdi.r09 <-
    ggplot(data = na.omit(family.data.gen)) +
    geom_point(aes(x = shannon, y = r.e0), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.r09)[1], sl = coef(lm.r09)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, linetype = "dashed", show.legend = TRUE) +
    geom_abline(data = data.frame(int = coef(mod.r09)[1], sl = coef(mod.r09)[2], col = "b"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, show.legend = TRUE) +
    labs(x = "Mycorrhizal Type Shannon Index", y = "Diversification Rate", col = "Model Type") +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS"), direction = -1) +
    theme_cowplot() +
    theme(legend.position = "top")


stem.age.sh <-
    ggplot(data = na.omit(family.data.gen)) +
    geom_point(aes(x = shannon, y = stem.age), size = 2) +
    geom_abline(data = data.frame(int = coef(pgls.age.sh)[1], sl = coef(pgls.age.sh)[2], col = "a"), mapping = aes(intercept = int, slope = sl, ,colour = col),  size = 1.5) +
    geom_abline(data = data.frame(int = coef(lm.age.sh)[1], sl = coef(lm.age.sh)[2], col = "blue"), mapping = aes(intercept = int, slope = sl, colour = col), linetype = "dashed", size = 1.5) +
    labs(x = "Mycorrhizal Type Diversity Index", y = "Family Age", colour = "Model Type") +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("PGLS", "Linear Model"))+
    theme_cowplot() +
    theme(legend.position = "top") 

rich.sh <-
    ggplot(data = na.omit(family.data.gen)) +
    geom_point(aes(x = shannon, y = rich), size = 2) +
    geom_abline(data = data.frame(int = coef(pgls.rich.sh)[1], sl = coef(pgls.rich.sh)[2], col = "a"), mapping = aes(intercept = int, slope = sl, ,colour = col), size = 1.5) +
    geom_abline(data = data.frame(int = coef(lm.rich.sh)[1], sl = coef(lm.rich.sh)[2], col = "blue"), mapping = aes(intercept = int, slope = sl, colour = col), linetype = "dashed", size = 1.5) +
    labs(x = "Mycorrhizal Type Diversity Index", y = "Species Richness", colour = "Model Type") +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("PGLS", "Linear Model")) +
    theme_cowplot() +
    theme(legend.position = "top")


plot_grid(mtdi.r0,
          mtdi.r09,
          ncol = 2,
          align = 'hv',
          axis = 'tlbr',
          labels = letters[1:2]
          )

```

```{r}

reg.sum <- data.frame(epsilon = c(0, 0.9),
                      pvalue.PGLS = c(4.637e-08, 6.858e-08),
                      R2.PGLS = c(0.07343, 0.07157),
                      pvalue.LM = c(6.325e-10, 4.512e-09),
                      R2.LM = c(0.09319, 0.08402))

reg.sum[, 2:5] <- apply(reg.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = reg.sum, format = "latex", caption = "Summary statistics for the phylogenetic and parametric regressions using the full genus dataset. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

# Family classification based on different thresholds

```{r}

fam.class <- data.frame(Threshold = c("50", "60", "80", "100"),
                        rbind(table(family.data.gen$type.50),
                              table(family.data.gen$type.60),
                              table(family.data.gen$type.80),
                              table(family.data.gen$type.100)))

# fam.class <- apply(fam.class, 2, sig.formatter)

kable_styling(kable(x = fam.class, format = "latex", caption = "Mycorrhizal type assigned to each family based on 4 different percentage thresholds (50, 60, 80 and 100). Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

\pagebreak

# Species-level database

```{r}

## This step is mandatory to avoid problems with overlapping object names
rm(list = ls())
load("../output/suppdata_species_noremarks.RData")
sig.formatter <- function(x){cell_spec(x, format = "latex", bold = ifelse(x < 0.05, TRUE, FALSE))}

```

## Clean database - excluding species with any remark

### Boxplots

#### Threshold 50%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean$type.50 <- as.character(family.data.clean$type.50)
family.data.clean$type.60 <- as.character(family.data.clean$type.60)
family.data.clean$type.80 <- as.character(family.data.clean$type.80)
family.data.clean$type.100 <- as.character(family.data.clean$type.100)

box.r0 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

#### Threshold 60%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean$type.50 <- as.character(family.data.clean$type.50)
family.data.clean$type.60 <- as.character(family.data.clean$type.60)
family.data.clean$type.80 <- as.character(family.data.clean$type.80)
family.data.clean$type.100 <- as.character(family.data.clean$type.100)

box.r0 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

#### Threshold 80%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean$type.50 <- as.character(family.data.clean$type.50)
family.data.clean$type.60 <- as.character(family.data.clean$type.60)
family.data.clean$type.80 <- as.character(family.data.clean$type.80)
family.data.clean$type.100 <- as.character(family.data.clean$type.100)

box.r0 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

#### Threshold 100%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean$type.50 <- as.character(family.data.clean$type.50)
family.data.clean$type.60 <- as.character(family.data.clean$type.60)
family.data.clean$type.80 <- as.character(family.data.clean$type.80)
family.data.clean$type.100 <- as.character(family.data.clean$type.100)

box.r0 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0,
          box.r09,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

## Summary statistics

### phyANOVA

```{r}

phyaov.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                                   F.r0 = round(c(phyaov.r0.50$F,
                                            phyaov.r0.60$F,
                                            phyaov.r0.80$F,
                                            phyaov.r0.100$F), 3),
                                   pvalue.r0 = round(c(phyaov.r0.50$Pf,
                                                 phyaov.r0.60$Pf,
                                                 phyaov.r0.80$Pf,
                                                 phyaov.r0.100$Pf), 3),
                                   F.r09 = round(c(phyaov.r09.50$F,
                                            phyaov.r09.60$F,
                                            phyaov.r09.80$F,
                                            phyaov.r09.100$F), 3),
                                   pvalue.r09 = round(c(phyaov.r09.50$Pf,
                                                 phyaov.r09.60$Pf,
                                                 phyaov.r09.80$Pf,
                                                 phyaov.r09.100$Pf), 3)
                         )

phyaov.sum[, 2:5] <- apply(phyaov.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = phyaov.sum, format = "latex", caption = "summary statistics for phyANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

std.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                      F.r0 = round(c(summary(aov.r0.50)[[1]]$F[1],
                               summary(aov.r0.60)[[1]]$F[1],
                               summary(aov.r0.80)[[1]]$F[1],
                               summary(aov.r0.100)[[1]]$F[1]), 3),
                      pvalue.r0 = round(c(summary(aov.r0.50)[[1]]$P[1],
                                    summary(aov.r0.60)[[1]]$P[1],
                                    summary(aov.r0.80)[[1]]$P[1],
                                    summary(aov.r0.100)[[1]]$P[1]), 3),
                      F.r09 = round(c(summary(aov.r09.50)[[1]]$F[1],
                                summary(aov.r09.60)[[1]]$F[1],
                                summary(aov.r09.80)[[1]]$F[1],
                                summary(aov.r09.100)[[1]]$F[1]), 3),
                      pvalue.r09 = round(c(summary(aov.r09.50)[[1]]$P[1],
                                     summary(aov.r09.60)[[1]]$P[1],
                                     summary(aov.r09.80)[[1]]$P[1],
                                     summary(aov.r09.100)[[1]]$P[1]), 3)
                      )

std.sum[, 2:5] <- apply(std.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = std.sum, format = "latex", caption = "summary statistics for phyANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

## Posthoc tests

### phyANOVA

```{r}

sum.phyaov <- setNames(
    data.frame(
        threshold = rep(c(50, 60, 80, 100), each = 4),
        Myc.type = rep(c("AM", "EM", "MIX", "NM"), times = 4),
        rbind(phyaov.r0.50$Pt,
              phyaov.r0.60$Pt,
              phyaov.r0.80$Pt,
              phyaov.r0.100$Pt),
        rbind(phyaov.r09.50$Pt,
              phyaov.r09.60$Pt,
              phyaov.r09.80$Pt,
              phyaov.r09.100$Pt)
    ), nm = c("Threshold", "Mycorrhizal.Type", "AM.r0", "EM.r0", "MIX.r0", "NM.r0", "AM.r09", "EM.r09", "MIX.r09", "NM.r09"))
rownames(sum.phyaov) <- NULL

sum.phyaov[, 3:10] <- apply(sum.phyaov[, 3:10], 2, sig.formatter)

kable_styling(kable(x = sum.phyaov, format = "latex", caption = "Pairwise Corrected p-values for phyANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

sum.aov <- setNames(
    data.frame(
        pairs = gsub("-", ".", names(TukeyHSD(aov.r0.50)$type.50[,4])),
        TukeyHSD(aov.r0.50)$type.50[,4],
        TukeyHSD(aov.r0.60)$type.60[,4],
        TukeyHSD(aov.r0.80)$type.80[,4],
        TukeyHSD(aov.r0.100)$type.100[,4],
        TukeyHSD(aov.r09.50)$type.50[,4],
        TukeyHSD(aov.r09.60)$type.60[,4],
        TukeyHSD(aov.r09.80)$type.80[,4],
        TukeyHSD(aov.r09.100)$type.100[,4]
        ), nm = c("Types", "50.r0", "60.r0", "80.r0", "100.r0", "50.r09", "60.r09", "80.r09", "100.r09"))

sum.aov <- apply(sum.aov, 2, sig.formatter)

kable_styling(kable(x = sum.aov, format = "latex", caption = "Pairwise Corrected p-values for standard ANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```



### Scatterplots

```{r fig.height = 5, fig.cap = "Scatterplots showing the relationship between mycorrhizal diversity index and diversification rates (a and c), species richness (b) and age family (d). Diversification rates were estimated with epsilon = 0 (a) and with epsilon = 0.9 (c). The red and blue lines indicate the results of a linear model and a phylogenetic generalized least squares (PGLS) fit, respectively."}

raw.r0 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = shannon, y = r.e0.stem), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.r0)[1], sl = coef(lm.r0)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, show.legend = TRUE) +
    geom_abline(data = data.frame(int = coef(mod.r0)[1], sl = coef(mod.r0)[2], col = "b"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, linetype = "dashed", show.legend = TRUE) +
    labs(x = "Mycorrhizae Type Shannon Index", y = "Diversification Rate", col = "Model Type") +
    #xlim(0, 1) +
    theme_cowplot() +
    theme(legend.position = "top") +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS"))

raw.r09 <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = shannon, y = r.e09.stem), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.r09)[1], sl = coef(lm.r09)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, show.legend = TRUE) +
    geom_abline(data = data.frame(int = coef(mod.r09)[1], sl = coef(mod.r09)[2], col = "b"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, linetype = "dashed", show.legend = TRUE) +
    labs(x = "Mycorrhizae Type Shannon Index", y = "Diversification Rate", col = "Model Type") +
    #xlim(0, 1) +
    theme_cowplot() +
    theme(legend.position = "top") +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS"))

stem.age.sh <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = shannon, y = stem.age), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.stem.age.sh)[1], sl = coef(lm.stem.age.sh)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5) +
    geom_abline(data = data.frame(int = coef(pgls.stem.age.sh)[1], sl = coef(pgls.stem.age.sh)[2], col = "blue"), mapping = aes(intercept = int, slope = sl, ,colour = col), linetype = "dashed", size = 1.5) +
    labs(x = "Mycorrhizal Type Diversity Index", y = "Family Age", col = element_blank()) +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS")) +
    theme_cowplot() +
    theme(legend.position = "top")

rich.sh <-
    ggplot(data = na.omit(family.data.clean)) +
    geom_point(aes(x = shannon, y = global.rich), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.rich.sh)[1], sl = coef(lm.rich.sh)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5) +
    geom_abline(data = data.frame(int = coef(pgls.rich.sh)[1], sl = coef(pgls.rich.sh)[2], col = "blue"), mapping = aes(intercept = int, slope = sl, ,colour = col), linetype = "dashed", size = 1.5) +
    labs(x = "Mycorrhizal Type Diversity Index", y = "Species Richness", col = element_blank()) +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS")) +
    theme_cowplot() +
    theme(legend.position = "top")


plot_grid(raw.r0,
          raw.r09,
          ncol = 2,
          align = 'hv',
          axis = 'tlbr',
          labels = letters[1:4]
          )

```

```{r}

reg.sum <- data.frame(epsilon = c(0, 0.9),
                      pvalue.PGLS = c(4.063e-07, 3.483e-07),
                      R2.PGLS = c(0.08904, 0.09007),
                      pvalue.LM = c(1.676e-07, 2.844e-07),
                      R2.LM = c(0.09458, 0.09109))

reg.sum[, 2:5] <- apply(reg.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = reg.sum, format = "latex", caption = "Summary statistics for the phylogenetic and parametric regressions using the full genus dataset. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

\pagebreak

## More inclusive database - including species with any remark

```{r}

## This step is mandatory to avoid problems with overlapping object names
rm(list = ls())
load("../output/suppdata_species_withremarks.RData")
sig.formatter <- function(x){cell_spec(x, format = "latex", bold = ifelse(x < 0.05, TRUE, FALSE))}

```

### Boxplots

#### Threshold 50%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean.rem$type.50 <- as.character(family.data.clean.rem$type.50)
family.data.clean.rem$type.60 <- as.character(family.data.clean.rem$type.60)
family.data.clean.rem$type.80 <- as.character(family.data.clean.rem$type.80)
family.data.clean.rem$type.100 <- as.character(family.data.clean.rem$type.100)

box.r0.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.50, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0.rem,
          box.r09.rem,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

#### Threshold 60%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean.rem$type.50 <- as.character(family.data.clean.rem$type.50)
family.data.clean.rem$type.60 <- as.character(family.data.clean.rem$type.60)
family.data.clean.rem$type.80 <- as.character(family.data.clean.rem$type.80)
family.data.clean.rem$type.100 <- as.character(family.data.clean.rem$type.100)

box.r0.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.60, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0.rem,
          box.r09.rem,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )



```

\pagebreak

#### Threshold 80%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean.rem$type.50 <- as.character(family.data.clean.rem$type.50)
family.data.clean.rem$type.60 <- as.character(family.data.clean.rem$type.60)
family.data.clean.rem$type.80 <- as.character(family.data.clean.rem$type.80)
family.data.clean.rem$type.100 <- as.character(family.data.clean.rem$type.100)

box.r0.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.80, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0.rem,
          box.r09.rem,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )



```

\pagebreak

#### Threshold 100%

```{r fig.cap = "Relationship between mycorrhizal type and diversification rates. a) diversification rate estimated with epsilon = 0 and b) diversification rate estimated with epsilon = 0.9. AM: Arbuscular mycorrhiza, EM: Ectomycorrhiza, NM: non-mycorrhizal and MIX (families with no dominance of any specific mycorrhizal association). The size of the points indicates the Mycorrhizal Type Diversity Index value for each lineage, indicating a predominance of larger indices with higher diversification rates."}

family.data.clean.rem$type.50 <- as.character(family.data.clean.rem$type.50)
family.data.clean.rem$type.60 <- as.character(family.data.clean.rem$type.60)
family.data.clean.rem$type.80 <- as.character(family.data.clean.rem$type.80)
family.data.clean.rem$type.100 <- as.character(family.data.clean.rem$type.100)

box.r0.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e0.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0 )"))

box.r09.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem, colour = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), size = shannon), alpha = 0.75, position = position_jitterdodge(jitter.width = 0.75, dodge.width = 1)) +
    geom_boxplot(aes(x = factor(type.100, levels = c("AM", "EM", "NM", "ER", "MIX")), y = r.e09.stem), fill = NA, colour = "darkgrey", outlier.alpha = 1) +
    theme_cowplot() +
    theme(legend.position = "none") +
    scale_colour_manual(values = brewer.pal(5, "Set1")[c(1:3, 5)]) +
    labs(x = "Mycorrhizal Type", y = expression("Diversification Rate ("~epsilon~" = 0.9 )"))


plot_grid(box.r0.rem,
          box.r09.rem,
          nrow = 2,
          align = 'v',
          labels = c("a", "b")
          )

```

\pagebreak

## Summary statistics

### phyANOVA

```{r}

phyaov.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                         F.r0 = round(c(phyaov.r0.50.rem$F,
                                  phyaov.r0.60.rem$F,
                                  phyaov.r0.80.rem$F,
                                  phyaov.r0.100.rem$F), 3),
                         pvalue.r0 = round(c(phyaov.r0.50.rem$Pf,
                                       phyaov.r0.60.rem$Pf,
                                       phyaov.r0.80.rem$Pf,
                                       phyaov.r0.100.rem$Pf), 3),
                         F.r09 = round(c(phyaov.r09.50.rem$F,
                                   phyaov.r09.60.rem$F,
                                   phyaov.r09.80.rem$F,
                                   phyaov.r09.100.rem$F), 3),
                         pvalue.r09 = round(c(phyaov.r09.50.rem$Pf,
                                        phyaov.r09.60.rem$Pf,
                                        phyaov.r09.80.rem$Pf,
                                        phyaov.r09.100.rem$Pf), 3)
                         )

phyaov.sum[, 2:5] <- apply(phyaov.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = phyaov.sum, format = "latex", caption = "summary statistics for phyANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

std.sum <- data.frame(Threshold = c(50, 60, 80, 100),
                      F.r0 = round(c(summary(aov.r0.50.rem)[[1]]$F[1],
                                     summary(aov.r0.60.rem)[[1]]$F[1],
                                     summary(aov.r0.80.rem)[[1]]$F[1],
                                     summary(aov.r0.100.rem)[[1]]$F[1]), 3),
                      pvalue.r0 = round(c(summary(aov.r0.50.rem)[[1]]$P[1],
                                          summary(aov.r0.60.rem)[[1]]$P[1],
                                          summary(aov.r0.80.rem)[[1]]$P[1],
                                          summary(aov.r0.100.rem)[[1]]$P[1]), 3),
                      F.r09 = round(c(summary(aov.r09.50.rem)[[1]]$F[1],
                                      summary(aov.r09.60.rem)[[1]]$F[1],
                                      summary(aov.r09.80.rem)[[1]]$F[1],
                                      summary(aov.r09.100.rem)[[1]]$F[1]), 3),
                      pvalue.r09 = round(c(summary(aov.r09.50.rem)[[1]]$P[1],
                                           summary(aov.r09.60.rem)[[1]]$P[1],
                                           summary(aov.r09.80.rem)[[1]]$P[1],
                                           summary(aov.r09.100.rem)[[1]]$P[1]), 3)
                      )

std.sum[, 2:5] <- apply(std.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = std.sum, format = "latex", caption = "summary statistics for phyANOVA for both values of epsilon. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

## Posthoc tests

### phyANOVA

```{r}

sum.phyaov <- setNames(
    data.frame(
        threshold = rep(c(50, 60, 80, 100), each = 4),
        Myc.type = rep(as.character(c("AM", "EM", "MIX", "NM")), times = 4),
        rbind(phyaov.r0.50.rem$Pt,
              phyaov.r0.60.rem$Pt,
              phyaov.r0.80.rem$Pt,
              phyaov.r0.100.rem$Pt),
        rbind(phyaov.r09.50.rem$Pt,
              phyaov.r09.60.rem$Pt,
              phyaov.r09.80.rem$Pt,
              phyaov.r09.100.rem$Pt),
        stringsAsFactors = FALSE
    ), nm = c("Threshold", "Mycorrhizal.Type", "AM.r0", "EM.r0", "MIX.r0", "NM.r0", "AM.r09", "EM.r09", "MIX.r09", "NM.r09"))
rownames(sum.phyaov) <- NULL

sum.phyaov[, 3:10] <- apply(sum.phyaov[, 3:10], 2, sig.formatter)

kable_styling(kable(x = sum.phyaov, format = "latex", caption = "Pairwise Corrected p-values for phyANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

### Standard ANOVA

```{r}

sum.aov <- setNames(
    data.frame(
        pairs = gsub("-", ".", names(TukeyHSD(aov.r0.50.rem)$type.50[,4])),
        TukeyHSD(aov.r0.50.rem)$type.50[,4],
        TukeyHSD(aov.r0.60.rem)$type.60[,4],
        TukeyHSD(aov.r0.80.rem)$type.80[,4],
        TukeyHSD(aov.r0.100.rem)$type.100[,4],
        TukeyHSD(aov.r09.50.rem)$type.50[,4],
        TukeyHSD(aov.r09.60.rem)$type.60[,4],
        TukeyHSD(aov.r09.80.rem)$type.80[,4],
        TukeyHSD(aov.r09.100.rem)$type.100[,4]
        ), nm = c("Types", "50.r0", "60.r0", "80.r0", "100.r0", "50.r09", "60.r09", "80.r09", "100.r09"))

sum.aov[, 2:9] <- apply(sum.aov[, 2:9], 2, sig.formatter)

kable_styling(kable(x = sum.aov, format = "latex", caption = "Pairwise Corrected p-values for standard ANOVA. Significant values are highlighted in bold.", row.names = FALSE, escape = FALSE, digits = 3), latex_options = "HOLD_position")

```


### Scatterplots

```{r fig.height = 5, fig.cap = "Scatterplots showing the relationship between mycorrhizal diversity index and diversification rates (a and c), species richness (b) and age family (d). Diversification rates were estimated with epsilon = 0 (a) and with epsilon = 0.9 (c). The red and blue lines indicate the results of a linear model and a phylogenetic generalized least squares (PGLS) fit, respectively."}

raw.r0.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = shannon, y = r.e0.stem), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.r0.rem)[1], sl = coef(lm.r0.rem)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, show.legend = TRUE) +
    geom_abline(data = data.frame(int = coef(mod.r0.rem)[1], sl = coef(mod.r0.rem)[2], col = "b"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, linetype = "dashed", show.legend = TRUE) +
    labs(x = "Mycorrhizae Type Shannon Index", y = "Diversification Rate", col = "Model Type") +
    #xlim(0, 1) +
    theme_cowplot() +
    theme(legend.position = "top") +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS"))

raw.r09.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = shannon, y = r.e09.stem), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.r09.rem)[1], sl = coef(lm.r09.rem)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, show.legend = TRUE) +
    geom_abline(data = data.frame(int = coef(mod.r09.rem)[1], sl = coef(mod.r09.rem)[2], col = "b"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5, linetype = "dashed", show.legend = TRUE) +
    labs(x = "Mycorrhizae Type Shannon Index", y = "Diversification Rate", col = "Model Type") +
    #xlim(0, 1) +
    theme_cowplot() +
    theme(legend.position = "top") +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS"))

stem.age.sh.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = shannon, y = stem.age), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.stem.age.sh.rem)[1], sl = coef(lm.stem.age.sh.rem)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5) +
    geom_abline(data = data.frame(int = coef(pgls.stem.age.sh.rem)[1], sl = coef(pgls.stem.age.sh.rem)[2], col = "blue"), mapping = aes(intercept = int, slope = sl, ,colour = col), linetype = "dashed", size = 1.5) +
    labs(x = "Mycorrhizal Type Diversity Index", y = "Family Age", col = element_blank()) +
    #xlim(0, 1) +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS")) +
    theme_cowplot() +
    theme(legend.position = "top")

rich.sh.rem <-
    ggplot(data = na.omit(family.data.clean.rem)) +
    geom_point(aes(x = shannon, y = global.rich), size = 2) +
    geom_abline(data = data.frame(int = coef(lm.rich.sh.rem)[1], sl = coef(lm.rich.sh.rem)[2], col = "a"), mapping = aes(intercept = int, slope = sl, colour = col), size = 1.5) +
    geom_abline(data = data.frame(int = coef(pgls.rich.sh.rem)[1], sl = coef(pgls.rich.sh.rem)[2], col = "blue"), mapping = aes(intercept = int, slope = sl, ,colour = col), linetype = "dashed", size = 1.5) +
    labs(x = "Mycorrhizal Type Diversity Index", y = "Species Richness", col = element_blank()) +
    #xlim(0, 1) +
    theme_cowplot() +
    scale_colour_brewer(palette = "Set1", labels = c("Linear Model", "PGLS")) +
    theme(legend.position = "top")


plot_grid(raw.r0.rem,
          raw.r09.rem,
          ncol = 2,
          align = 'hv',
          axis = 'tlbr',
          labels = letters[1:4]
          )

```

```{r}

reg.sum <- data.frame(epsilon = c(0, 0.9),
                      pvalue.PGLS = c(5.265e-05, 4.013e-05),
                      R2.PGLS = c(0.06444, 0.06653),
                      pvalue.LM = c(2.528e-07, 4.977e-07),
                      R2.LM = c(0.09354, 0.08898))

reg.sum[, 2:5] <- apply(reg.sum[, 2:5], 2, sig.formatter)

kable_styling(kable(x = reg.sum, format = "latex", caption = "Summary statistics for the phylogenetic and parametric regressions using the full genus dataset. Significant values are highlighted in bold.", escape = FALSE, digits = 3), latex_options = "HOLD_position")

```

# Adding randomly 20% of misassignment of mycorrhizal type

```{r}

rm(list = ls())
load("../output/results_20perc.RData")
sig.formatter <- function(x){cell_spec(x, format = "latex", bold = ifelse(x < 0.05, TRUE, FALSE))}

```

## Regressions

```{r fig.cap = "Distribution of (A) p-values and (B) R values for the same analyses of the main paper, but using all 50 replicate datasets with mycorrhizal types for 20% of species randomly sampled. Dashed vertical lines represent the corresponding empirical value from the main analysis."}

main.data.reg <- data.frame(
    epsilon = c(0, 0.9, 0, 0.9),
    model = c("PGLS", "PGLS", "LM", "LM"),
    pvalue = c(2.336e-12, 7.124e-13, 5.908e-15, 5.464e-15),
    R2 = c(0.1251, 0.1307, 0.1524, 0.1527)
)

pvalue.20perc.reg <-
    ggplot(data = pvalue.reg) +
    geom_histogram(aes(x = log10(pvalue), y = ..density.., fill = model), alpha = 0.3, colour = "white") +
    geom_density(aes(x = log10(pvalue), colour = model, fill = model), alpha = 0.3) +
    geom_vline(data = main.data.reg, aes(xintercept = log10(pvalue), group = model), colour = "black", linetype = "dashed") +
    facet_grid(model ~ epsilon) +
    scale_colour_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    scale_fill_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    labs(x = "R", y = "Density") +
    theme_cowplot() +
    theme(legend.position = "none")

pvalue.20perc.r2 <-
    ggplot(data = pvalue.reg) +
    geom_histogram(aes(x = R2, y = ..density.., fill = model), alpha = 0.3, colour = "white") +
    geom_density(aes(x = R2, fill = model, colour = model), alpha = 0.3) +
    geom_vline(data = main.data.reg, aes(xintercept = R2, group = model), colour = "black", linetype = "dashed") +
    facet_grid(model ~ epsilon) +
    scale_colour_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    scale_fill_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    labs(x = "R", y = "Density") +
    theme_cowplot() +
    theme(legend.position = "none")

plot_grid(pvalue.20perc.reg,
          pvalue.20perc.r2,
          ncol = 2,
          align = 'h',
          labels = LETTERS[1:2]
          )

```

\pagebreak

## ANOVAs

```{r fig.height = 13, fig.cap = "Distribution of p-values of (A) epsilon = 0 and (B) epsilon = 0.9 for the both phylogenetic and standard ANOVA, but using all 50 replicate datasets with mycorrhizal types for 20% of species randomly sampled. Dashed vertical lines represent the corresponding empirical value from the main analysis."}

main.data.aov <- data.frame(
    threshold = rep(c(50, 60, 80, 100), 2),
    model = rep(c("phy", "std"), each = 4),
    pvalue.r0 = c(0.089, 0.013, 0.001, 0.001),
    pvalue.r09 = c(0.162, 0.007, 0.001, 0.001)
    )

pvalue.20perc.aov.r0 <-
    ggplot(data = pvalue.aov) +
    geom_histogram(aes(x = pvalue.r0, y = ..density.., fill = model), alpha = 0.3, colour = "white") +
    geom_vline(data = main.data.aov, aes(xintercept = pvalue.r0, group = model), colour = "black", linetype = "dashed") +
    facet_grid(threshold ~ model) +
    scale_colour_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    scale_fill_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    labs(x = "R", y = "Density") +
    theme_cowplot() +
    theme(legend.position = "none")

pvalue.20perc.aov.r09 <-
    ggplot(data = pvalue.aov) +
    geom_histogram(aes(x = pvalue.r09, y = ..density.., fill = model), alpha = 0.3, colour = "white") +
    geom_vline(data = main.data.aov, aes(xintercept = pvalue.r09, group = model), colour = "black", linetype = "dashed") +
    facet_grid(threshold ~ model) +
    scale_colour_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    scale_fill_manual(values = RColorBrewer::brewer.pal(3, "Set1")[2:1]) +
    labs(x = "R", y = "Density") +
    theme_cowplot() +
    theme(legend.position = "none")

plot_grid(pvalue.20perc.aov.r0,
          pvalue.20perc.aov.r09,
          ncol = 2,
          align = 'h',
          labels = LETTERS[1:2]
          )

```
